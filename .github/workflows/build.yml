name: Build and Release

on:
  push:
    branches:
      # - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Setup application icon
        run: |
          Copy-Item "favicon_io/favicon.ico" "build/windows/icon.ico" -Force
          Copy-Item "favicon_io/android-chrome-512x512.png" "build/appicon.png" -Force
        shell: pwsh

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev" >> $GITHUB_OUTPUT
          fi

      - name: Build Windows application
        run: |
          $env:GIT_COMMIT = git rev-parse --short HEAD
          wails build -platform windows/amd64 -ldflags "-X main.GitCommit=$env:GIT_COMMIT"
        shell: pwsh

      - name: Create Windows ZIP
        run: |
          cd build/bin
          Compress-Archive -Path WinCleaner.exe -DestinationPath ../../WinCleaner-windows-amd64.zip
        shell: pwsh

      - name: Download Inno Setup Chinese language file
        run: |
          $issDir = "C:\Program Files (x86)\Inno Setup 6\Languages"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/Unofficial/ChineseSimplified.isl" -OutFile "$issDir\ChineseSimplified.isl"
        shell: pwsh

      - name: Build Installer with Inno Setup
        run: |
          iscc /DMyAppVersion="${{ steps.get_version.outputs.VERSION }}" build/installer.iss
        shell: cmd

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ github.sha }}
          path: |
            WinCleaner-windows-amd64.zip
            WinCleaner-Setup-*.exe
          retention-days: 5

  release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build-${{ github.sha }}
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Win Cleaner v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ§¹ Win Cleaner v${{ steps.get_version.outputs.VERSION }}
            
            Windows ç³»ç»Ÿåƒåœ¾æ¸…ç†ä¸ä¼˜åŒ–å·¥å…·
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - ğŸ§¹ **åƒåœ¾æ¸…ç†**: æ‰«æå¹¶æ¸…ç† 7 ç±»ç³»ç»Ÿåƒåœ¾ï¼ˆä¸´æ—¶æ–‡ä»¶ã€æ›´æ–°ç¼“å­˜ã€ç¼©ç•¥å›¾ã€æ—¥å¿—ã€æµè§ˆå™¨ç¼“å­˜ã€å›æ”¶ç«™ã€é¢„è¯»å–ï¼‰
            - ğŸ§  **å†…å­˜ä¼˜åŒ–**: ä¸€é”®æ”¶ç¼©è¿›ç¨‹å·¥ä½œé›†ï¼Œé‡Šæ”¾ç‰©ç†å†…å­˜
            - ğŸ“Š **ç³»ç»Ÿæ¦‚è§ˆ**: CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡ï¼Œæ˜¾å¡ä¿¡æ¯æ£€æµ‹
            - ğŸ“‹ **è¿›ç¨‹ç®¡ç†**: æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨ï¼ŒæŒ‰ CPU/å†…å­˜æ’åºï¼Œæ”¯æŒç»“æŸè¿›ç¨‹
            - ğŸŒ **æµé‡ç›‘æ§**: å®æ—¶ç½‘é€Ÿã€è¿›ç¨‹ç½‘ç»œä½¿ç”¨ã€å†å²æµé‡ç»Ÿè®¡å›¾è¡¨
            - ğŸ’¾ **ç£ç›˜ç®¡ç†**: åˆ†åŒºç©ºé—´æ¦‚è§ˆã€å¤§æ–‡ä»¶æ‰«æ
            - ğŸ“ˆ **å†å²å›¾è¡¨**: æ¸…ç†è®°å½•ã€ä¼˜åŒ–è®°å½•ã€æµé‡ç»Ÿè®¡çš„å¯è§†åŒ–å›¾è¡¨
            
            ### ğŸ’¾ ä¸‹è½½
            
            - `WinCleaner-Setup-*.exe` - å®‰è£…ç¨‹åºï¼ˆæ¨èï¼Œå«æ¡Œé¢å¿«æ·æ–¹å¼å’Œå¸è½½ï¼‰
            - `WinCleaner-windows-amd64.zip` - å…å®‰è£…ç‰ˆï¼Œè§£å‹å³ç”¨
            
            ### ğŸ“ æŠ€æœ¯æ ˆ
            
            - Wails v2 (Go + Vue3 + Element Plus + ECharts)
            - çº¯æœ¬åœ°è¿è¡Œï¼Œä¸ä¸Šä¼ ä»»ä½•æ•°æ®
          files: |
            artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
